<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unibet × Polymarket Arb Scanner — No‑Worker Fallback</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .mono{font-variant-numeric:tabular-nums; font-feature-settings:"tnum" on,"lnum" on}
    .pill{display:inline-flex;align-items:center;justify-content:center;border-radius:9999px;padding:.25rem .625rem;font-size:.75rem;font-weight:600}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="flex items-start justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold">Unibet × Polymarket Arb Scanner</h1>
        <p class="text-sm text-gray-600">Works without a server: paste Unibet odds manually; Polymarket fetched directly. (You can add a Worker later.)</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-black text-white font-semibold shadow">Refresh</button>
      </div>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-2xl p-4 sm:p-5 shadow">
        <h2 class="font-semibold mb-3">Inputs</h2>
        <div class="grid grid-cols-2 gap-3">
          <label class="flex flex-col gap-1">
            <span class="text-sm text-gray-600">Stake per team</span>
            <input id="stakeInput" type="number" step="1" min="1" value="100" class="rounded-xl border px-3 py-2 mono" />
          </label>
          <label class="flex flex-col gap-1">
            <span class="text-sm text-gray-600">Currency</span>
            <select id="ccy" class="rounded-xl border px-3 py-2">
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
              <option value="GBP">GBP</option>
            </select>
          </label>
          <label class="flex items-center gap-2 col-span-2">
            <input id="useFees" type="checkbox" class="w-4 h-4" />
            <span class="text-sm">Apply Polymarket fee on net winnings</span>
          </label>
          <label class="flex flex-col gap-1">
            <span class="text-sm text-gray-600">PM fee %</span>
            <input id="feePct" type="number" step="0.1" value="0" class="rounded-xl border px-3 py-2 mono" />
          </label>
          <label class="flex flex-col gap-1">
            <span class="text-sm text-gray-600">Hedge mode</span>
            <select id="hedgeMode" class="rounded-xl border px-3 py-2">
              <option value="best">Best of (Buy NO vs Sell YES)</option>
              <option value="buyNO">Buy NO only</option>
              <option value="sellYES">Sell YES only</option>
            </select>
          </label>
        </div>
      </div>

      <div class="bg-white rounded-2xl p-4 sm:p-5 shadow">
        <h2 class="font-semibold mb-3">Data status</h2>
        <div class="text-sm space-y-2">
          <div>Unibet source: <span id="unibetStatus" class="pill bg-gray-100 text-gray-700">manual</span></div>
          <div>Polymarket: <span id="polyStatus" class="pill bg-gray-100 text-gray-700">…</span></div>
          <p class="text-xs text-gray-500">Paste Unibet odds below. You can switch to a Cloudflare Worker later to auto-pull Unibet.</p>
        </div>
      </div>

      <div class="bg-white rounded-2xl p-4 sm:p-5 shadow">
        <h2 class="font-semibold mb-3">Filters</h2>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <label class="flex flex-col gap-1 col-span-2">
            <span class="text-sm text-gray-600">Search teams</span>
            <input id="search" placeholder="Type to filter…" class="rounded-xl border px-3 py-2" />
          </label>
          <label class="flex items-center gap-2 col-span-2">
            <input id="onlyArbs" type="checkbox" class="w-4 h-4" />
            <span>Show arbs only</span>
          </label>
        </div>
      </div>
    </section>

    <section class="bg-white rounded-2xl p-4 sm:p-5 shadow mb-6">
      <h2 class="font-semibold mb-3">Paste Unibet odds (one per line)</h2>
      <p class="text-sm text-gray-600 mb-2">Accepts formats like: <code>Buffalo Bills, 8.0</code> or <code>Buffalo Bills 8.0</code> or <code>Buffalo Bills\t8.0</code></p>
      <textarea id="unibetText" rows="8" class="w-full rounded-xl border p-3 font-mono text-sm" placeholder="Buffalo Bills, 8.0
Kansas City Chiefs, 9.0
Green Bay Packers, 21.0"></textarea>
    </section>

    <section class="bg-white rounded-2xl p-3 sm:p-5 shadow">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold mb-3">Opportunities</h2>
        <button id="exportBtn" class="px-3 py-1.5 rounded-xl border text-sm">Export CSV</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-xs uppercase text-gray-500 border-b">
            <tr>
              <th class="py-2 pr-3">Team</th>
              <th class="py-2 pr-3">Unibet (Dec)</th>
              <th class="py-2 pr-3">PM Sell YES Bid</th>
              <th class="py-2 pr-3">PM Buy NO Ask</th>
              <th class="py-2 pr-3">Dmin (Sell YES)</th>
              <th class="py-2 pr-3">Dmin (Buy NO)</th>
              <th class="py-2 pr-3">Arb via</th>
              <th class="py-2 pr-3">Total bet (Unibet)</th>
              <th class="py-2 pr-3">Total received (PM)</th>
              <th class="py-2 pr-3">Total return</th>
              <th class="py-2 pr-3">Total return %</th>
            </tr>
          </thead>
          <tbody id="rows" class="divide-y"></tbody>
        </table>
      </div>
    </section>

    <details class="mt-6 text-sm text-gray-600">
      <summary class="cursor-pointer font-semibold">Optional: add a Cloudflare Worker later (auto‑pull Unibet)</summary>
      <ol class="list-decimal ml-5 mt-2 space-y-1">
        <li>Create a free account at Cloudflare → Workers & Pages → "Create Worker" → Quick Edit.</li>
        <li>Paste the Module Worker code I gave earlier (or ask me to paste it again), click **Save & Deploy**.</li>
        <li>Copy your worker URL (e.g., <code>https://something.workers.dev</code>) and set <code>WORKER_BASE</code> in the script.</li>
      </ol>
    </details>
  </div>

<script>
// If you later add a Worker, set this to your URL; leave empty for direct Polymarket + manual Unibet
const WORKER_BASE = ""; 
const POLY_SLUG = "super-bowl-champion-2026-731";

const $ = id => document.getElementById(id);
const fmt = (x,d=2)=> (x===null||x===undefined||isNaN(x))?"–":Number(x).toFixed(d);

function parseUnibetText(txt){
  const lines = (txt||"").split(/\n+/);
  const rows = [];
  for(const ln of lines){
    const s = ln.trim(); if(!s) continue;
    // split by comma, tab, or last space number
    let team=null, odd=null;
    const m1 = s.match(/^(.*?)[,\t]\s*([0-9]+(?:\.[0-9]+)?)$/); // "Team, 8.0" or "Team\t8.0"
    if(m1){ team = m1[1].trim(); odd = parseFloat(m1[2]); }
    else {
      const m2 = s.match(/^(.*)\s([0-9]+(?:\.[0-9]+)?)$/); // "Team 8.0"
      if(m2){ team = m2[1].trim(); odd = parseFloat(m2[2]); }
    }
    if(team && isFinite(odd) && odd>1) rows.push({ team, oddsDec: odd });
  }
  // keep best odds per team
  const map = new Map();
  for(const r of rows){
    const k = r.team.toLowerCase();
    if(!map.has(k) || map.get(k).oddsDec < r.oddsDec) map.set(k, r);
  }
  return Object.fromEntries([...map.values()].map(r=>[normalize(r.team), r]));
}

function normalize(s){ return s.toLowerCase().replace(/[^a-z0-9]/g, "").replace(/^the/,""); }

async function fetchPolymarket(){
  try{
    if(WORKER_BASE){
      const r = await fetch(`${WORKER_BASE}/polymarket-superbowl?slug=${encodeURIComponent(POLY_SLUG)}`);
      if(!r.ok) throw new Error("worker poly fail");
      return await r.json();
    }
    // direct: Gamma + CLOB
    const ev = await fetch(`https://gamma-api.polymarket.com/events?slug=${encodeURIComponent(POLY_SLUG)}`);
    if(!ev.ok) throw new Error("gamma fail");
    const arr = await ev.json();
    const event = Array.isArray(arr)?arr[0]:(arr?.data?.[0]||arr);
    const mkts = (event?.markets||[]).map(m=>({
      question: m.question || m.marketTitle || m.title || "",
      yes: (m.clob_token_ids||m.clobTokenIds||m.tokens||[])[0] ?? null,
      no:  (m.clob_token_ids||m.clobTokenIds||m.tokens||[])[1] ?? null,
    }));
    const norm = mkts.map(m=>{
      let team = m.question.replace(/Will (the )?/i,'').replace(/win the.*$/i,'').replace(/win .*$/i,'').replace(/\?$/,'').replace(/^the /i,'').replace(/\s+\(.*\)$/,'').trim();
      return { team, yes:m.yes, no:m.no };
    }).filter(r=>r.team);
    const ids=[...new Set(norm.flatMap(r=>[r.yes,r.no].filter(Boolean)))]
    let book={};
    if(ids.length){
      const [bids,asks] = await Promise.all([
        fetch("https://clob.polymarket.com/prices",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({params:ids.map(t=>({token_id:t,side:"SELL"}))})}),
        fetch("https://clob.polymarket.com/prices",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({params:ids.map(t=>({token_id:t,side:"BUY"}))})}),
      ]);
      const bj = bids.ok?await bids.json():{prices:[]};
      const aj = asks.ok?await asks.json():{prices:[]};
      for(const p of bj.prices||[]) book[p.token_id]={bid:Number(p.price)};
      for(const p of aj.prices||[]) book[p.token_id]={...(book[p.token_id]||{}),ask:Number(p.price)};
    }
    return norm.map(r=>({
      team:r.team,
      yesBid: r.yes ? (book[r.yes]?.bid ?? null) : null,
      yesAsk: r.yes ? (book[r.yes]?.ask ?? null) : null,
      noBid:  r.no  ? (book[r.no ]?.bid ?? null) : null,
      noAsk:  r.no  ? (book[r.no ]?.ask ?? null) : null,
    }));
  }catch(e){
    console.error(e); return [];
  }
}

function dMinSellYES(p){ if(!p||p<=0) return null; return 1/p; }
function dMinBuyNO(q){ if(q===null||q===undefined) return null; if(q>=1) return null; return 1/(1-q); }

function calcPnL({stake,D,pYesBid,qNoAsk,mode,feePct}){
  const fee = Math.max(0, feePct||0)/100;
  if(mode === 'sellYES'){
    if(!pYesBid) return {arb:false};
    if(D < 1/pYesBid) return {arb:false};
    const m = stake * D; // shares
    const pmCashIn = pYesBid * m;
    // Equalized profit ignoring fee:
    let profit = stake * (pYesBid * D - 1);
    if(fee>0){
      const pmPos = pYesBid * m; // PM positive leg when team loses
      profit -= fee * pmPos;
    }
    return {arb:true, via:'sellYES', betUnibet:stake, pmReceived:pmCashIn, totalReturn:profit, totalReturnPct:(profit/stake)*100};
  } else {
    if(qNoAsk===null||qNoAsk===undefined) return {arb:false};
    if(D < 1/(1-qNoAsk)) return {arb:false};
    const n = stake * D; // shares
    const pmCashOut = qNoAsk * n;
    let profit = stake * (D*(1 - qNoAsk) - 1);
    if(fee>0){
      const pmPos = n * (1 - qNoAsk);
      profit -= fee * pmPos;
    }
    return {arb:true, via:'buyNO', betUnibet:stake, pmReceived:-pmCashOut, totalReturn:profit, totalReturnPct:(profit/stake)*100};
  }
}

async function run(){
  const stake = parseFloat($("stakeInput").value||"100");
  const feePct = $("useFees").checked ? parseFloat($("feePct").value||"0") : 0;
  const modeSel = $("hedgeMode").value;
  const ccy = $("ccy").value || "EUR";

  // Unibet manual parse
  const unibetMap = parseUnibetText($("unibetText").value);
  $("unibetStatus").textContent = `manual (${Object.keys(unibetMap).length} teams)`;
  $("unibetStatus").className = "pill bg-blue-100 text-blue-700";

  // Polymarket
  $("polyStatus").textContent = "loading…";
  let poly = await fetchPolymarket();
  if(poly.length){
    $("polyStatus").textContent = `ok (${poly.length})`;
    $("polyStatus").className = "pill bg-green-100 text-green-700";
  } else {
    $("polyStatus").textContent = "error";
    $("polyStatus").className = "pill bg-red-100 text-red-700";
  }

  const rowsEl = $("rows");
  const search = $("search").value.trim().toLowerCase();
  const onlyArbs = $("onlyArbs").checked;

  // Build map: team -> polymarket prices
  const polyMap = Object.fromEntries(poly.map(m=>[normalize(m.team), m]));

  const rows=[];
  for(const k of Object.keys(unibetMap)){
    const u = unibetMap[k];
    const m = polyMap[k];
    if(!m) continue;
    const D = u.oddsDec;
    const pBid = m.yesBid; const qAsk = m.noAsk;
    const sellThresh = dMinSellYES(pBid);
    const buyThresh  = dMinBuyNO(qAsk);

    let best = {arb:false};
    if(modeSel==='best'){
      const sell = calcPnL({stake,D,pYesBid:pBid,qNoAsk:qAsk,mode:'sellYES',feePct});
      const buy  = calcPnL({stake,D,pYesBid:pBid,qNoAsk:qAsk,mode:'buyNO', feePct});
      if(sell.arb && buy.arb) best = (sell.totalReturn > buy.totalReturn) ? sell : buy;
      else best = sell.arb ? sell : (buy.arb ? buy : {arb:false});
    } else if(modeSel==='sellYES') best = calcPnL({stake,D,pYesBid:pBid,qNoAsk:qAsk,mode:'sellYES',feePct});
    else best = calcPnL({stake,D,pYesBid:pBid,qNoAsk:qAsk,mode:'buyNO',feePct});

    const isArb = best.arb;
    const via = best.via || '—';
    const name = u.team || m.team;
    if(search && !name.toLowerCase().includes(search)) continue;
    if(onlyArbs && !isArb) continue;

    rows.push({
      name,
      html:`<tr class="${isArb?'bg-green-50':''}">
        <td class="py-2 pr-3">${name}</td>
        <td class="py-2 pr-3 mono">${fmt(D,2)}</td>
        <td class="py-2 pr-3 mono">${fmt(pBid,3)}</td>
        <td class="py-2 pr-3 mono">${fmt(qAsk,3)}</td>
        <td class="py-2 pr-3 mono">${sellThresh?fmt(sellThresh,2):'–'}</td>
        <td class="py-2 pr-3 mono">${buyThresh?fmt(buyThresh,2):'–'}</td>
        <td class="py-2 pr-3">${isArb? (via==='sellYES'?'Sell YES':'Buy NO') : '–'}</td>
        <td class="py-2 pr-3 mono">${ccy} ${isArb?fmt(best.betUnibet,2):fmt(stake,2)}</td>
        <td class="py-2 pr-3 mono">${isArb? (ccy+' '+fmt(best.pmReceived,2)) : '–'}</td>
        <td class="py-2 pr-3 mono font-semibold">${isArb? (ccy+' '+fmt(best.totalReturn,2)) : '–'}</td>
        <td class="py-2 pr-3 mono font-semibold">${isArb? (fmt(best.totalReturnPct,2)+'%') : '–'}</td>
      </tr>`
    });
  }

  // Sort by total return desc (naive)
  rowsEl.innerHTML = rows.map(r=>r.html).join("");
}

function exportCSV(){
  const headers = ["Team","UnibetDec","PM_SellYES_Bid","PM_BuyNO_Ask","Dmin_SellYES","Dmin_BuyNO","ArbVia","BetUnibet","PMReceived","TotalReturn","TotalReturnPct"];
  const rows = Array.from(document.querySelectorAll('#rows tr')).map(tr => Array.from(tr.querySelectorAll('td')).map(td=>td.innerText.replace(/[,]/g,'')) );
  const data = [headers, ...rows];
  const csv = data.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'arb_scanner.csv'; a.click(); URL.revokeObjectURL(url);
}

["stakeInput","feePct","useFees","hedgeMode","search","onlyArbs","ccy","unibetText"].forEach(id=>{
  $(id).addEventListener('input', ()=>run());
  $(id).addEventListener('change', ()=>run());
});
$("refreshBtn").addEventListener('click', run);
$("exportBtn").addEventListener('click', exportCSV);

run();
</script>
</body>
</html>
